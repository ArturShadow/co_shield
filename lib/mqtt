import 'package:mqtt_client/mqtt_client.dart';
import 'package:mqtt_client/mqtt_server_client.dart';

void main() async {
  final client = MqttServerClient('broker.arduino.cc', 'your_client_identifier')
    ..port = 8883
    ..logging(on: false)
    ..securityContext = MqttClientSecurityContext() // Necesitarás establecer un contexto de seguridad si usas SSL/TLS
    ..setProtocolV311()
    ..autoReconnect = true
    ..onDisconnected = _onDisconnected
    ..onConnected = _onConnected
    ..onSubscribed = _onSubscribed;

  final connMessage = MqttConnectMessage()
      .withClientIdentifier('your_client_identifier')
      .authenticateAs('your_username', 'your_password') // Necesitarás proporcionar un nombre de usuario y contraseña válidos
      .keepAliveFor(21600) // Keep alive establecido a 6 horas
      .withWillQos(MqttQos.atLeastOnce);
  client.connectionMessage = connMessage;

  try {
    await client.connect();
  } catch (e) {
    print('Exception: $e');
    client.disconnect();
  }

  // Si la conexión es exitosa
  if (client.connectionStatus.state == MqttConnectionState.connected) {
    print('Connected');
    client.subscribe('your_topic', MqttQos.atLeastOnce); // Suscríbete a un tópico específico
  } else {
    print('Connection failed - disconnecting');
    client.disconnect();
  }
}

void _onDisconnected() {
  print('Disconnected');
}

void _onConnected() {
  print('Connected');
}

void _onSubscribed(String topic) {
  print('Subscribed to topic: $topic');
}
